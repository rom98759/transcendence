<!doctype html>
<html lang="fr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Auth - Connexion / Inscription</title>
	<style>
		:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0}
		body{display:flex;align-items:center;justify-content:center;height:100vh;background:#f3f6fb;color:#111}
		.container{display:grid;grid-template-columns:1fr 1fr;gap:24px;width:900px;max-width:96%;padding:28px}
		.card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(20,30,60,0.08)}
		h2{margin:0 0 12px;font-size:18px}
		label{display:block;font-size:13px;margin-top:10px}
		input[type="text"],input[type="password"]{width:100%;padding:10px;margin-top:6px;border:1px solid #d4dce6;border-radius:6px;box-sizing:border-box}
		button{margin-top:16px;padding:10px 14px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
		button:disabled{opacity:.6;cursor:default}
		.msg{margin-top:12px;font-size:13px}
		.success{color:green}
		.error{color:#b91c1c}
		.small{font-size:12px;color:#666;margin-top:8px}
		@media (max-width:720px){.container{grid-template-columns:1fr;}}
	</style>
</head>
<body>

	<div class="container">
		<div class="card" id="loginCard">
			<h2>Connexion</h2>
			<form id="loginForm">
				<label for="loginUsername">Nom d'utilisateur</label>
				<input id="loginUsername" name="username" type="text" required autocomplete="username" />
				<label for="loginPassword">Mot de passe</label>
				<input id="loginPassword" name="password" type="password" required autocomplete="current-password" />
				<button type="submit" id="loginBtn">Connexion</button>
				<div class="msg" id="loginMsg"></div>
				<div class="small">Envoi POST vers: <code>/api/auth/login</code></div>
			</form>
		</div>

		<div class="card" id="registerCard">
			<h2>Inscription</h2>
			<form id="registerForm">
				<label for="regUsername">Nom d'utilisateur</label>
				<input id="regUsername" name="username" type="text" required autocomplete="username" />
				<label for="regEmail">Email</label>
				<input id="regEmail" name="email" type="text" required autocomplete="email" />
				<label for="regPassword">Mot de passe</label>
				<input id="regPassword" name="password" type="password" required autocomplete="new-password" />
				<button type="submit" id="regBtn">S'inscrire</button>
				<div class="msg" id="regMsg"></div>
				<div class="small">Envoi POST vers: <code>/api/auth/register</code></div>
			</form>
		</div>

		<div class="card" id="logoutCard">
			<h2>Logout</h2>
			<button id="logoutBtn">Se déconnecter</button>
			<div class="msg" id="logoutMsg"></div>
		</div>
		<script>
			document.getElementById('logoutBtn').addEventListener('click', async () => {
				const logoutMsg = document.getElementById('logoutMsg');
				logoutMsg.textContent = ''; logoutMsg.className = 'msg';
				try {
					const res = await fetch('/api/auth/logout', {
						method: 'POST',
						credentials: 'include',
					});
					if (res.ok) {
						logoutMsg.textContent = 'Déconnexion réussie';
						logoutMsg.classList.add('success');
					} else {
						logoutMsg.textContent = `Erreur (${res.status}) lors de la déconnexion`;
						logoutMsg.classList.add('error');
					}
				} catch (err) {
					logoutMsg.textContent = 'Requête impossible: ' + err.message;
					logoutMsg.classList.add('error');
				}
			});
		</script>

		<div class="card"><strong>Statut:</strong>
			<span id="healthStatus">Chargement...</span>
		<script>
			fetch('/health')
				.then(res => {
					const statusElem = document.getElementById('healthStatus');
					if (res.ok) {
						statusElem.textContent = 'OK';
						statusElem.style.color = 'green';
					} else {
						statusElem.textContent = `Erreur (${res.status})`;
						statusElem.style.color = 'red';
					}
				})
				.catch(() => {
					const statusElem = document.getElementById('healthStatus');
					statusElem.textContent = 'Inaccessible';
					statusElem.style.color = 'red';
				});
		</script>

		<div class="card" id="token">
			<h2>Get Token in cookies</h2>
			<span id="tokenValue">Chargement...</span>
			<button id="refreshTokenBtn">Rafraîchir</button>
		<script>
			function getCookie(name) {
				const value = `; ${document.cookie}`;
				const parts = value.split(`; ${name}=`);
				if (parts.length === 2) return parts.pop().split(';').shift();
			}
			const tokenElem = document.getElementById('tokenValue');
			const token = getCookie('token');
			if (token) {
				tokenElem.textContent = token;
				tokenElem.style.color = 'green';
			} else {
				tokenElem.textContent = 'Aucun token trouvé';
				tokenElem.style.color = 'red';
			}

			document.getElementById('refreshTokenBtn').addEventListener('click', () => {
				console.log(document.cookie);
				const token = getCookie('token');
				if (token) {
					tokenElem.textContent = token;
					tokenElem.style.color = 'green';
				} else {
					tokenElem.textContent = 'Aucun token trouvé';
					tokenElem.style.color = 'red';
				}
			});
		</script>
		</div>
	</div>

		<div class="card" id="me">
			<h2>Me</h2>
			<button id="meBtn">Obtenir les informations de l'utilisateur connecté</button>
			<div class="msg" id="meMsg"></div>
		</div>


	</div>

	<script>
		const loginForm = document.getElementById('loginForm');
		const registerForm = document.getElementById('registerForm');
		const loginMsg = document.getElementById('loginMsg');
		const regMsg = document.getElementById('regMsg');
		const loginBtn = document.getElementById('loginBtn');
		const regBtn = document.getElementById('regBtn');
		const meBtn = document.getElementById('meBtn');
		const meMsg = document.getElementById('meMsg');

		async function postJson(url, body) {
			const res = await fetch(url, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				// include credentials so cookies set by the gateway/auth are accepted by the browser
				credentials: 'include',
				body: JSON.stringify(body),
			});
			const text = await res.text();
			// try parse json, fallback to text
			try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
			catch { return { ok: res.ok, status: res.status, data: text }; }
		}

		loginForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			loginMsg.textContent = ''; loginMsg.className = 'msg';
			loginBtn.disabled = true;
			const username = document.getElementById('loginUsername').value.trim();
			const password = document.getElementById('loginPassword').value;
			try {
				const result = await postJson('/api/auth/login', { username, password });
				if (result.ok) {
					loginMsg.textContent = 'Connexion réussie';
					loginMsg.classList.add('success');
					console.log('Données reçues:', result.data);
				} else {
					loginMsg.textContent = `Erreur (${result.status}): ${JSON.stringify(result.data)}`;
					loginMsg.classList.add('error');
				}
			} catch (err) {
				loginMsg.textContent = 'Connexion impossible: ' + err.message;
				loginMsg.classList.add('error');
			} finally {
				loginBtn.disabled = false;
			}
		});

		registerForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			regMsg.textContent = ''; regMsg.className = 'msg';
			regBtn.disabled = true;
			const username = document.getElementById('regUsername').value.trim();
			const email = document.getElementById('regEmail').value.trim();
			const password = document.getElementById('regPassword').value;
			try {
				const result = await postJson('/api/auth/register', { username, email, password });
				if (result.ok) {
					regMsg.textContent = 'Inscription réussie';
					regMsg.classList.add('success');
					console.log('Données reçues:', result.data);
				} else {
					regMsg.textContent = `Erreur (${result.status}): ${JSON.stringify(result.data)}`;
					regMsg.classList.add('error');
				}
			} catch (err) {
				regMsg.textContent = 'Requête impossible: ' + err.message;
				regMsg.classList.add('error');
			} finally {
				regBtn.disabled = false;
			}
		});

		meBtn.addEventListener('click', async () => {
			meMsg.textContent = ''; meMsg.className = 'msg';
			meBtn.disabled = true;
			try {
				const res = await fetch('/api/auth/me', {
					method: 'GET',
					credentials: 'include',
				});
				const text = await res.text();
				let data;
				try { data = JSON.parse(text); } catch { data = text; }
				if (res.ok) {
					meMsg.textContent = 'Données reçues: ' + JSON.stringify(data);
					meMsg.classList.add('success');
				} else {
					meMsg.textContent = `Erreur (${res.status}): ${JSON.stringify(data)}`;
					meMsg.classList.add('error');
				}
			} catch (err) {
				meMsg.textContent = 'Requête impossible: ' + err.message;
				meMsg.classList.add('error');
			} finally {
				meBtn.disabled = false;
			}
		});
	</script>
</body>
</html>