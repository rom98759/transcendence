<%- include('header.ejs', {title}) %>
<div class="text-center my-4">
    <h3 class="fw-bold"><%= message %></h3>
</div>
<div class="max-w-6xl mx-auto px-4 space-y-6">

    <!-- Carte d'enregistrement snapshot blockchain -->
    <div class="rounded-xl border bg-white shadow-sm border-gray-200" id="registerCard">
        <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 text-gray-600 rounded-t-xl">
            <h2 class="text-lg font-semibold">Adding manually a tournament</h2>
        </div>
        <div class="spx-6 p-4">
            <form class="space-y-4" id="registerForm">
                <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium" for="regmId">tour_id</label>
                    <input id="regmId" name="tour_id" type="text"
                    class="rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200 border-gray-200"/>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <% for (let i = 1; i <= 4; i++) { %>
                  <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium">player<%= i %></label>
                    <input id="regp<%= i %>Id" type="text"
                           class="rounded-md border px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-200 border-gray-200" />
                  </div>
                  <% } %>
                </div>
                <button class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-50" type="submit" id="regBtn">Ajouter un tournoi</button>
                <div class="text-xs" id="regMsg"></div>
                <div class="text-xs text-gray-500">Envoi POST vers: <code class="font-mono text-blue-600">:redis publisher</code></div>
            </form>
        </div>
    </div>
    <script>
        // Code de la carte d'enregistrement snapshot blockchain
        const registerForm = document.getElementById("registerForm");
        const regMsg = document.getElementById("regMsg");
        const regBtn = document.getElementById("regBtn");

        async function postJson(url, body) {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(body)
            });
            const text = await res.text();
            try {
                return { ok: res.ok, status: res.status, data: JSON.parse(text) };
            } catch {
                return { ok: res.ok, status: res.status, data: text };
            }
        }

        registerForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            regMsg.textContent = "";
            regMsg.className = "msg";
            regBtn.disabled = true;
            const tour_id = document.getElementById("regmId").value;
            const player1 = document.getElementById("regp1Id").value;
            const player2 = document.getElementById("regp2Id").value;
            const player3 = document.getElementById("regp3Id").value;
            const player4 = document.getElementById("regp4Id").value;
            try {
                const result = await postJson("/tournamentspub", { tour_id, player1, player2,player3,player4  });
                if (result.ok) {
                    regMsg.textContent = "Inscription réussie";
                    regMsg.classList.add("success");
                    console.log("Données reçues:", result.data);
                } else {
                    regMsg.textContent = `Erreur (${result.status}): ${JSON.stringify(result.data)}`;
                    regMsg.classList.add("error");
                }
            } catch (err) {
                regMsg.textContent = "Requête impossible: " + err.message;
                regMsg.classList.add("error");
            } finally {
                regBtn.disabled = false;
            }
        });
    </script>

    <%- include('snapshots.ejs') %>
    
    <div class="overflow-x-auto rounded-xl border bg-white shadow-sm border-gray-200">
        <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 text-gray-600 rounded-t-xl">
            <h2 class="text-lg font-semibold">List of tournaments in snapshot</h2>
        </div>
    
    <div>
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                <tr>
                    <th class="px-4 py-3 text-left">id</th>
                    <th class="px-4 py-3">tx_hash</th>
                    <th class="px-4 py-3">snap_hash</th>
                    <th class="px-4 py-3">block_timestamp</th>
                    <th class="px-4 py-3">t_id</th>
                    <th class="px-4 py-3">p1_id</th>
                    <th class="px-4 py-3">p2_id</th>
                    <th class="px-4 py-3">p3_id</th>
                    <th class="px-4 py-3">p4_id</th>
                </tr>
            </thead>
            <tbody class="divide-y">
            <% for (const row of snapshots) { %>
            <tr class="hover:bg-gray-50 border-gray-200">
                <td class="px-4 py-2"><%= row.id %></td>
                <td class="px-4 py-2 font-mono text-xs truncate max-w-xs"><%= row.tx_hash %></td>
                <td class="px-4 py-2 font-mono text-xs truncate max-w-xs"><%= row.snap_hash %></td>
                <td class="px-4 py-2"><%= row.block_timestamp %></td>
                <td class="px-4 py-2"><%= row.tour_id %></td>
                <td class="px-4 py-2"><%= row.player1_id %></td>
                <td class="px-4 py-2"><%= row.player2_id %></td>
                <td class="px-4 py-2"><%= row.player3_id %></td>
                <td class="px-4 py-2"><%= row.player4_id %></td>
            </tr>
            <% } %>
            </tbody>
        </table>
    </div>
    </div>

    <!-- Carte Me -->
    <div class="rounded-xl border bg-white shadow-sm border-gray-200" id="me">
            <div class="border-b border-gray-200 px-6 py-4 bg-gray-50 text-gray-600 rounded-t-xl">
                <h2 class="text-lg font-semibold">Liste des Users</h2>
            </div>
            <div class="d-flex gap-2 m-4">
                <button id="meBtn" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">Obtenir les informations</button>
                <button id="clearBtn" class="rounded-md bg-gray-200 px-4 py-2 text-sm hover:bg-gray-300">Clear</button>
            </div>

            <div id="meMsg" class="space-y-2"></div>
    </div>

    <script>
        const meBtn = document.getElementById("meBtn");
        const clearBtn = document.getElementById("clearBtn");
        const meMsg = document.getElementById("meMsg");

        // Action : Clear
        clearBtn.addEventListener("click", () => {
            meMsg.innerHTML = "";
            meMsg.className = "";
        });

        // Action : Obtenir les données
        meBtn.addEventListener("click", async () => {
            meMsg.innerHTML = "";
            meMsg.className = "";
            meBtn.disabled = true;

            try {
                const res = await fetch("/tournaments", {
                    method: "GET",
                    credentials: "include"
                });

                const text = await res.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = text;
                }

                if (res.ok) {
                    if (Array.isArray(data)) {
                        // Construction de la liste Bootstrap
                        const ul = document.createElement("ul");
                        ul.className = "divide-y rounded-md border border-gray-200 m-4";

                        data.forEach((item) => {
                            const li = document.createElement("li");
                            li.className = "px-4 py-2 flex justify-between text-sm border-gray-200";
                            li.innerHTML = `
							<span><strong>Tour ID:</strong> ${item.tour_id} winner is => ${item.player1_id}</span>
						`;
                            ul.appendChild(li);
                        });

                        meMsg.appendChild(ul);
                        meMsg.classList.add("mt-3");
                    } else {
                        meMsg.innerHTML = `<div class="alert alert-success">Données: ${JSON.stringify(data)}</div>`;
                    }
                } else {
                    meMsg.innerHTML = `
					<div class="alert alert-danger">
						Erreur (${res.status}): ${JSON.stringify(data)}
					</div>`;
                }
            } catch (err) {
                meMsg.innerHTML = `<div class="alert alert-danger">Requête impossible: ${err.message}</div>`;
            } finally {
                meBtn.disabled = false;
            }
        });
    </script>
</div>

<%- include('footer.ejs') %>
