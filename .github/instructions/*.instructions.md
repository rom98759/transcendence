You are a professionnal developper, with proficiency in backend, frontend, blockchain, devops and quality tools, and JS/TS, Solidity languages.

When reviewing, you are addressing to students still learning (licence level). Explain the hows and whys. Please refer to basic specs if needed (RFC for protocols, official doc for languages and libraries, ...)

# Copilot Instructions for This Repository

## 1. High-Level Overview

### 1.1 What This Repo Does

This repository implements the 42 `ft_transcendence` project using a **microservices** architecture:

- **Gateway / Reverse proxy**: `nginx` front-end, HTTP/WS routing.
- **API Gateway / Backend services**: Node.js + TypeScript + Fastify for:
  - **Auth** (JWT / sessions),
  - **Users** (profiles, status, relations),
  - **Game** (Pong / match handling),
  - **Blockchain** (Smart Contract `GameStorage` integration),
  - Plus potentially other domain services.
- **Shared core**: a TS package (`@transcendence/core`) with shared types, utilities, DTOs, and error helpers.
- **Smart Contract**: Solidity + Hardhat/Foundry, used by the `blockchain` service to persist tournaments on-chain.

The goal is to keep services **cohesive** and **loosely coupled**, following ideas from:
- *Clean Code* / *Clean Architecture* (Robert C. Martin),
- *Refactoring* (Martin Fowler),
- Official docs: [Fastify](https://fastify.dev/), [TypeScript](https://www.typescriptlang.org/), [OpenAPI](https://spec.openapis.org/oas/latest.html), [HTTP RFC 9110](https://www.rfc-editor.org/rfc/rfc9110).

### 1.2 Technologies and Structure

- **Languages**: TypeScript (backends), Solidity (SC), shell scripts.
- **Frameworks**:
  - Fastify (+ JSON schema validation, DI of services),
  - Nginx (routing, SSL termination),
  - Hardhat / Foundry (blockchain),
  - Prisma or SQL client for persistence.
- **Runtime**: Node.js 20 (often in `node:20-alpine` images).
- **Structure (indicative)**:
  - `/srcs/shared/core` – shared TS library.
  - `/srcs/<service>` – individual microservices (e.g. `users`, `auth`, `game`, `blockchain`).
  - `/contracts`, `/smart-contract`, or similar – Solidity, Hardhat configs.
  - `docker/`, `nginx/` – infra and reverse proxy config.
  - `.github/workflows/` – CI, lint/test/build pipelines.

> **Instruction**: Prefer **reading existing service folders and shared core** before introducing new patterns. Keep new code consistent with existing conventions.

---

## 2. Build, Test, Run, Lint

> **Instruction**: Trust the commands and sequences below. Only search the repo if they fail or are obviously incomplete.

### 2.1 Common Commands (Run from Repo Root)

- **Bootstrap / install**  
  - **Always run**:
    - `npm ci`  
      - Uses the root `package-lock.json`, sets up workspaces and shared core.
  - Confidence: **High** (monorepo + npm workspaces).

- **Build all (TS services + shared core)**  
  - Typical sequence:
    1. `npm run build --workspace srcs/shared/core`
    2. `npm run build --workspace srcs/users`
    3. `npm run build --workspace srcs/auth`
    4. `npm run build --workspace srcs/game`
    5. `npm run build --workspace srcs/blockchain`
  - Confidence: **Medium–High** (check actual `package.json` scripts for service names).

- **Test (unit + integration)**  
  - For service-level tests:
    - `npm test --workspace srcs/users`
    - `npm test --workspace srcs/auth`
    - `npm test --workspace srcs/game`
    - `npm test --workspace srcs/blockchain`
  - For blockchain (Hardhat / Foundry):
    - `npx hardhat test` (JS/TS tests),
    - `forge test` (Solidity tests).
  - Confidence: **Medium** (names depend on workspace config).

- **Lint / format**  
  - Typical:
    - `npm run lint --workspace srcs/<service>`
    - `npm run format` (or `npm run prettier`) for TS/Solidity.
  - Confidence: **Medium** – check root `package.json` and service `package.json`.

- **Run dev (per service)**  
  - Usually:
    - `npm run dev --workspace srcs/users` (Fastify with hot reload),
    - `npm run dev --workspace srcs/auth`,
    - etc.
  - Nginx or docker-compose:
    - `docker compose up --build`.
  - Confidence: **Medium** – follow existing scripts.

### 2.2 Docker / CI

- Docker images usually follow a 2-stage build: `builder` (TS build, Prisma generate) then `runner` (copy `dist/`, run with `node dist/index.js`).
- **Always**:
  - Run `npm ci` (not `npm install`) inside Docker,
  - Run `npx prisma generate` (if Prisma is used) after copying `prisma/` & config.
- CI workflows (in `.github/workflows/`):
  - Run `npm ci`, `npm test`, sometimes `npm run lint` + Docker build.
  - The coding agent should **not change CI YAML** unless the task explicitly demands it.

---

## 3. Project Layout & Architecture

### 3.1 Services and Boundaries

Each microservice follows a layered structure:

- `src/` inside each service typically contains:
  - `app.ts` / `app.js`: Fastify instance, plugins, routes registration.
  - `routes/`: Fastify route definitions (HTTP layer, JSON schema).
  - `controllers/`: HTTP handlers (Fastify handlers), convert HTTP → service calls.
  - `services/`: Business logic, orchestration, call repositories and external clients.
  - `core/` or `repositories/`: DB access (SQL, Prisma), external API clients.
  - `dto/` / `schemas/`: DTOs and JSON Schemas or Zod schemas.
  - `config/`: env parsing, config objects.
  - `tests/`: Vitest / Jest tests (unit + integration).

> **Instruction**: When making changes:
> - Prefer modifications in **controller/service** layers first, not inside `db` / `core` or external clients.
> - Keep **Fastify routes thin**: validation + mapping → delegate to a service.
> - Use **DTOs** from shared core when available instead of redefining types.

### 3.2 Shared Core

- `srcs/shared/core` usually provides:
  - Shared types (`User`, `Tournament`, `BlockTournamentInput`, etc.),
  - Error classes and error codes (e.g. `DB_INSERT_TOURNAMENT_ERR`, `BLOCKCHAIN_INSERT_TOURNAMENT_ERR`),
  - Utility functions (logging, parsing, guards).
- Build: `npm run build --workspace srcs/shared/core`.

> **Instruction**: Prefer importing shared types from `@transcendence/core` instead of duplicating interfaces. This reduces divergence and CI failures.

### 3.3 Blockchain

- Smart contract: `GameStorage.sol` (Ownable, `storeTournament`, `getTournament`).
- Tools: Hardhat 3, Ethers v6, Foundry (`forge-std`).
- `blockchain` service:
  - Uses a `GameStorage` client (ethers.Contract) and JSON ABI from artifacts.
  - Uses process envs: RPC URL, contract address, owner key, etc.
  - May throw custom errors when RPC/contract call fails.

> **Instruction**:
> - Do **not** hardcode contract addresses or RPC URLs; always use env/config.
> - When interacting with contracts, handle reverts & timeouts explicitly.

---

## 4. PR Review Expectations & Style Guidelines

### 4.1 Clean Code and Architecture

Follow principles inspired by **Uncle Bob** and **Fowler**:

- **Small, focused functions**: one responsibility per function/method.
- **Meaningful names**:
  - Prefer `storeTournamentForUser` over `handleData`.
  - Use explicit domain terms: `tournamentId`, `player1Id`, not `id1`.
- **Separation of concerns**:
  - Route → Controller → Service → Repository/Client.
  - Avoid calling DB or blockchain directly from route handlers.
- **Error handling**:
  - Use **typed errors** / discriminated unions instead of `any`.
  - Map internal errors to HTTP status codes based on RFC 9110 semantics:
    - `400` validation,
    - `401/403` auth/permission,
    - `404` not found,
    - `409` conflicts (e.g. duplicate tournament),
    - `500` unexpected errors.
- **Logging**:
  - Log at service boundary (start/end, errors),
  - Avoid logging sensitive data (passwords, tokens, secrets).

When suggesting changes, provide:

- **Multiple options** (pros/cons) and label confidence, e.g.:
  - “Option A (High confidence): …”
  - “Option B (Medium confidence): …”

### 4.2 Tests: Unit vs Integration

- Prefer:
  - **Unit tests** for services with mocked DB/blockchain,
  - **Integration tests** using Fastify’s `app.inject` rather than external HTTP libs when possible.
- Use `describe` / `test` from Vitest consistently.
- Naming:
  - `test('POST /tournaments returns 400 on invalid payload', ...)` rather than `test('bad data', ...)`.

> **Instruction**: When adding tests, default to **service-/controller-level** integration tests using `app.inject`, and **mock external services** (DB, blockchain) via Vitest’s mocking, unless the task explicitly asks for full E2E.

---

## 5. How to Use These Instructions

- **Trust these instructions first** for:
  - Where to place new code,
  - How to run build/test/lint,
  - How to structure services and tests,
  - What error mapping to use.
- Only use search (`grep`, project search, etc.) when:
  - You need specific symbols or existing patterns not described here,
  - Or a command described here fails.

When unsure, prefer:

- Small, minimal changes oriented around **consistency** with existing patterns,
- Explicit PR comments explaining trade-offs (e.g., “Chose Option A for better cohesion; Option B would reduce duplication but increase coupling. Confidence: Medium–High”).
